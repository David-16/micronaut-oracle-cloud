<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script src="/cdn-cgi/apps/head/3cOPSgo5Omz84ycX7CvigfX4cpw.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-82213539-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-82213539-2');
    </script>
    <title>7 Oracle Functions HTTP (Serverless) 1.0.0.BUILD-SNAPSHOT</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Micronaut Oracle Cloud
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/introduction.html"><strong>1</strong><span>Introduction</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/quickStart.html"><strong>2</strong><span>Quick Start</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/authentication.html"><strong>3</strong><span>Authentication</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/modules.html"><strong>4</strong><span>Available Modules</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/rxjava.html"><strong>5</strong><span>RxJava 2 Support</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/functions.html"><strong>6</strong><span>Oracle Functions (Serverless)</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/httpFunctions.html"><strong>7</strong><span>Oracle Functions HTTP (Serverless)</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../guide/functions.html">&lt;&lt; <strong>6</strong><span>Oracle Functions (Serverless)</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                


                <div class="project">
                    <h1>7 Oracle Functions HTTP (Serverless)</h1>

                    <p><strong>Version:</strong> 1.0.0.BUILD-SNAPSHOT</p>
                </div>

                

                
<h1 id="httpFunctions"><a class="anchor" href="#httpFunctions"></a>7 Oracle Functions HTTP (Serverless)</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-oracle-cloud/edit/master/src/main/docs/guide/httpFunctions.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The <code>micronaut-oci-function-http</code> module gives you the ability to write HTTP API Gateway function handlers that delegate to regular Micronaut controllers.</p>
</div>
<div class="paragraph">
<p>Create your controller just as you would a normal Micronaut controller.</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import com.oracle.bmc.objectstorage.ObjectStorage;
import com.oracle.bmc.objectstorage.model.BucketSummary;
import com.oracle.bmc.objectstorage.model.CreateBucketDetails;
import com.oracle.bmc.objectstorage.model.ListObjects;
import com.oracle.bmc.objectstorage.model.ObjectSummary;
import com.oracle.bmc.objectstorage.requests.*;
import com.oracle.bmc.objectstorage.responses.GetNamespaceResponse;
import io.micronaut.core.util.CollectionUtils;
import io.micronaut.http.MediaType;
import io.micronaut.http.annotation.*;
import io.micronaut.oci.core.TenancyIdProvider;

import javax.annotation.Nullable;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.stream.Collectors;

@Controller("/os")
public class BucketController {
    private final ObjectStorage objectStorage;
    private final TenancyIdProvider tenancyIdProvider;

    public BucketController(
            ObjectStorage objectStorage,
            TenancyIdProvider tenancyIdProvider) { <b class="conum">(1)</b>
        this.objectStorage = objectStorage;
        this.tenancyIdProvider = tenancyIdProvider;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This example uses the <code>micronaut-oci-sdk</code> module to perform Object Storage operations, so the <code>ObjectStorage</code> client and <code>TenancyIdProvider</code> are injected.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, add a controller method to list all of the buckets in a compartment:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Get("/buckets{/compartmentId}")
public List&lt;String&gt; listBuckets(@PathVariable @Nullable String compartmentId) {
    String compartmentOcid = compartmentId != null ? compartmentId : tenancyIdProvider.getTenancyId();
    GetNamespaceRequest getNamespaceRequest = GetNamespaceRequest.builder()
            .compartmentId(compartmentOcid).build();
    final GetNamespaceResponse namespaceResponse = objectStorage.getNamespace(getNamespaceRequest);
    final ListBucketsRequest.Builder builder = ListBucketsRequest.builder();
    builder.namespaceName(namespaceResponse.getValue());
    builder.compartmentId(compartmentOcid);
    return objectStorage.listBuckets(builder.build())
                    .getItems()
                    .stream()
                    .map(BucketSummary::getName)
                    .collect(Collectors.toList());
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="http-functions-dockerfile">Dockerfile</h3>
<div class="paragraph">
<p>Since Micronaut&#8217;s support for Oracle Functions depends upon the GraalVM <code>native-image</code> plugin, you will need to include the following <code>Dockerfile</code> in your function&#8217;s root directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Dockerfile hljs" data-lang="Dockerfile">FROM oracle/graalvm-ce:20.1.0-java11 as graalvm
RUN gu install native-image

WORKDIR /home/app
COPY build/layers/libs /home/app/libs
COPY build/layers/resources /home/app/resources
COPY build/layers/application.jar /home/app/application.jar

RUN native-image --static \
                 -H:Name=func \
                 --report-unsupported-elements-at-runtime \
                 --initialize-at-build-time=example \
                 --no-server \
                 -H:IncludeResources=simplelogger.properties \
                 --no-fallback \
                 -cp /home/app/libs/*.jar:/home/app/resources:/home/app/application.jar \
                 com.fnproject.fn.runtime.EntryPoint


# need socket library from Fn FDK
FROM fnproject/fn-java-fdk:1.0.105 as fnfdk

# Package native binary in minimal container image
FROM oraclelinux:7-slim
WORKDIR /function
RUN groupadd -g 1000 fn &amp;&amp; useradd --uid 1000 -g fn fn
COPY --from=graalvm /home/app/func func
# get unix socket libraries from FDK container image
COPY --from=fnfdk /function/runtime/lib/* .
ENTRYPOINT ["./func", "-XX:MaximumHeapSizePercent=80"]
CMD [ "io.micronaut.oci.function.http.HttpFunction::handleRequest" ]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_build_deploy">Build &amp; Deploy</h3>
<div class="paragraph">
<p>Build your application with <code>./gradlew buildLayers</code> and deploy with <code>fn deploy --app [your app name]</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_api_gateway">API Gateway</h3>
<div class="paragraph">
<p>You&#8217;ll need to create an API Gateway to route requests to your serverless deployment. The Micronaut router will call the proper controller function based on the incoming HTTP Request Method and the path.</p>
</div>
<div class="paragraph">
<p>First, create an API Gateway by selecting 'Developer Services', then 'API Gateway' from the Oracle Cloud console dashboard.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/api-gateway-menu.png" alt="API Gateway Menu">
</div>
</div>
<div class="paragraph">
<p>Click on 'Create Gateway'.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/create-gateway.png" alt="Create Gateway Button">
</div>
</div>
<div class="paragraph">
<p>Enter a name for the gateway, choose the compartment it is stored in and the network and subnet.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/gateway-details.png" alt="Create Gateway Button">
</div>
</div>
<div class="paragraph">
<p>When the gateway is ‘Active’, click ‘Deployments’, then ‘Create Deployment’.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/create-deployment-button.png" alt="Create Gateway Button">
</div>
</div>
<div class="paragraph">
<p>Provide a name for the deployment and enter a “Path Prefix”. If necessary, configure any Authentication, CORS or Rate Limiting and click ’Next’.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The path prefix must match the path you used in your controller (IE: <code>@Controller("/os")</code>).
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/deployment-details-basic.png" alt="Create Gateway Button">
</div>
</div>
<div class="paragraph">
<p>Enter route information.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Enter <code>/{path*}</code> as the Path. This will capture all incoming requests and the Micronaut router will match the incoming path and request method with the proper controller method.</p>
</li>
<li>
<p>Choose <code>ANY</code> for methods. Optionally, choose the necessary methods individually.</p>
</li>
<li>
<p>Choose 'Oracle Functions' as the type.</p>
</li>
<li>
<p>Choose the appropriate Oracle Functions application.</p>
</li>
<li>
<p>Choose the function name that you used. This can be found in your function&#8217;s <code>func.yaml</code> file.</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/deployment-routes.png" alt="Create Gateway Button">
</div>
</div>
<div class="paragraph">
<p>Click 'Next', then review the deployment details and click 'Create'.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/deployment-review.png" alt="Review Deployment Details">
</div>
</div>
<div class="paragraph">
<p>Your new deployment will be listed in 'Creating' state.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/deployment-creating.png" alt="Deployment Creating">
</div>
</div>
<div class="paragraph">
<p>When your new deployment becomes 'Active', click on the deployment to view the deployment details. Copy the 'Endpoint' - this is the base URL that you&#8217;ll use for your function invocations.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/deployment-details.png" alt="Create Gateway Button">
</div>
</div>
<div class="paragraph">
<p>Test your functions by appending the proper controller path and one of your controller endpoints.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/deployment-invocation.png" alt="Create Gateway Button">
</div>
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../guide/functions.html">&lt;&lt; <strong>6</strong><span>Oracle Functions (Serverless)</span></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
